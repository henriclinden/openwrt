// SPDX-License-Identifier: GPL-2.0-or-later OR MIT
// Henric Lind√©n, PCTEL Inc.

#include "qcom-ipq4019.dtsi"
#include <dt-bindings/gpio/gpio.h>
#include <dt-bindings/input/input.h>
#include <dt-bindings/soc/qcom,tcsr.h>

/ {
    model = "PCTEL AP-WIFI-1200";
    compatible = "pctel,ap-wifi-1200";

    aliases {
        led-boot = &power_amber;
        led-failsafe = &power_red;
        led-running = &power_green;
        led-upgrade = &power_amber;
    };

    memory {
        device_type = "memory";
        reg = <0x80000000 0x10000000>;
    };

    chosen {
        bootargs-append = " ubi.mtd=ubi root=/dev/ubiblock0_1";
    };

    soc {
        rng@22000 {
            status = "okay";
        };

        mdio@90000 {
            status = "okay";
            pinctrl-0 = <&mdio_pins>;
            pinctrl-names = "default";

            /delete-node/ ethernet-phy@1;
            /delete-node/ ethernet-phy@2;
            /delete-node/ ethernet-phy@3;
            /delete-node/ ethernet-phy@4;
            /delete-node/ psgmii-phy@5;
        };

        counter@4a1000 {
            compatible = "qcom,qca-gcnt";
            reg = <0x4a1000 0x4>;
        };

        tcsr@1949000 {
            compatible = "qcom,tcsr";
            reg = <0x1949000 0x100>;
            qcom,wifi_glb_cfg = <TCSR_WIFI_GLB_CFG>;
        };

        ess_tcsr@1953000 {
            compatible = "qcom,tcsr";
            reg = <0x1953000 0x1000>;
            qcom,ess-interface-select = <TCSR_ESS_PSGMII_RGMII5>;
        };

        tcsr@1957000 {
            compatible = "qcom,tcsr";
            reg = <0x1957000 0x100>;
            qcom,wifi_noc_memtype_m0_m2 = <TCSR_WIFI_NOC_MEMTYPE_M0_M2>;
        };

        crypto@8e3a000 {
            status = "okay";
        };

        watchdog@b017000 {
            status = "okay";
        };

        ess-switch@c000000 {
            switch_mac_mode = <0x3>; /* mac mode for RGMII RMII */
            //switch_mac_mode = <0x1>; /* mac mode for RGMII RMII */
            switch_lan_bmp = <0x0>; /* lan port bitmap */
            switch_wan_bmp = <0x10>; /* wan port bitmap */
        };

        edma@c080000 {
            status = "okay";
            // -id = no delay, -rxid = RX path delay, -txid = TX path delay (standard = 2.5us)
            phy-mode = "rgmii-id";
            //phy-mode = "rgmii-rxid";
            qcom,num_gmac = <1>;
            qcom,single-phy;
        };
    };

    keys {
        compatible = "gpio-keys";

        reset {
            label = "reset";
            gpios = <&tlmm 18 GPIO_ACTIVE_LOW>;
            linux,code = <KEY_RESTART>;
        };
    };

    leds {
        compatible = "gpio-leds";

        power_amber: power_amber {
            gpios = <&tlmm 40 GPIO_ACTIVE_LOW>;
            label = "amber:power";
        };

        power_green: power_green {
            gpios = <&tlmm 39 GPIO_ACTIVE_LOW>;
            label = "green:power";
        };

        power_red: power_red {
            gpios = <&tlmm 45 GPIO_ACTIVE_LOW>;
            label = "red:power";
        };
    };
};

&tlmm {
    serial_0_pins: serial_0_pinmux {
        mux {
            pins = "gpio16", "gpio17";
            function = "blsp_uart0";
            bias-disable;
        };
    };

   // Bluetooth chipset (UART1) on GPIO pin 9 and 8.
   // TODO: add enable and reset pins.
    serial_1_pins: serial_1_pinmux {
        mux {
            pins = "gpio9", "gpio8";
            function = "blsp_uart1";
            bias-disable;
        };
    };

    spi_0_pins: spi_0_pinmux {
        pin {
            function = "blsp_spi0";
            pins = "gpio13", "gpio14", "gpio15";
            drive-strength = <12>;
            bias-disable;
        };
        pin_cs {
            function = "gpio";
            pins = "gpio12";
            drive-strength = <2>;
            bias-disable;
            output-high;
        };
    };

    nand_pins: nand_pins {
        pullups {
            pins = "gpio53", "gpio58", "gpio59";
            function = "qpic";
            bias-pull-up;
        };

        pulldowns {
            pins = "gpio55", "gpio56", "gpio57", "gpio60",
            "gpio62", "gpio63", "gpio64", "gpio65",
            "gpio66", "gpio67", "gpio68", "gpio69";
            function = "qpic";
            bias-pull-down;
        };
    };

    mdio_pins: mdio_pinmux {
        mux_1 {
            pins = "gpio6";
            function = "mdio";
            bias-pull-up;
        };
        mux_2 {
            pins = "gpio7";
            function = "mdc";
            bias-pull-up;
        };
    };

    phy-reset {

        line-name = "PHY-reset";
        gpios = <47 GPIO_ACTIVE_HIGH>;
        gpio-hog;
        output-high;
    };
};

&blsp1_spi1 {
    pinctrl-0 = <&spi_0_pins>;
    pinctrl-names = "default";
    status = "okay";
    cs-gpios = <&tlmm 12 GPIO_ACTIVE_HIGH>;

    m25p80@0 {
        compatible = "jedec,spi-nor";
        reg = <0>;
        spi-max-frequency = <24000000>;

        partitions {
            compatible = "fixed-partitions";
            #address-cells = <1>;
            #size-cells = <1>;

            partition0@0 {
                label = "SBL1";
                reg = <0x00000000 0x00040000>;
                read-only;
            };

            partition1@40000 {
                label = "MIBIB";
                reg = <0x00040000 0x00020000>;
                read-only;
            };

            partition2@60000 {
                label = "QSEE";
                reg = <0x00060000 0x00060000>;
                read-only;
            };

            partition3@c0000 {
                label = "CDT";
                reg = <0x000c0000 0x00010000>;
                read-only;
            };

            partition4@d0000 {
                label = "DDRPARAMS";
                reg = <0x000d0000 0x00010000>;
                read-only;
            };

            partition5@E0000 {
                label = "APPSBLENV";
                reg = <0x000e0000 0x00010000>;
                read-only;
            };

            partition6@F0000 {
                label = "APPSBL";
                reg = <0x000f0000 0x00100000>;
                read-only;
            };

            partition7@1f0000 {
                label = "ART";
                reg = <0x001f0000 0x00010000>;
                read-only;

                compatible = "nvmem-cells";
                #address-cells = <1>;
                #size-cells = <1>;
                
                precal_art_1000: precal@1000 {
                    reg = <0x1000 0x2f20>;
                };

                precal_art_5000: precal@5000 {
                    reg = <0x5000 0x2f20>;
                };
            };
        };
    };
};

&nand {
    pinctrl-0 = <&nand_pins>;
    pinctrl-names = "default";
    status = "okay";

    nand@0 {
        partitions {
            compatible = "fixed-partitions";
            #address-cells = <1>;
            #size-cells = <1>;

            partition@0 {
                label = "rootfs";
                reg = <0x0 0x4000000>;
            };
        };
    };
};

&qpic_bam {
    status = "okay";
};

&blsp_dma {
    status = "okay";
};

// Serial console
&blsp1_uart1 {
    pinctrl-0 = <&serial_0_pins>;
    pinctrl-names = "default";
    status = "okay";
};

// Bluetooth (TI SimpleLink CC2640)
// Not a HCI module, unfortunately.
&blsp1_uart2 {
    pinctrl-0 = <&serial_1_pins>;
    pinctrl-names = "default";
    status = "okay";
    bluetooth {
        compatible = "ti,cc2640";
        enable-gpios = <&tlmm 12 GPIO_ACTIVE_LOW>;
    };
};

&gmac0 {
    qcom,phy_mdio_addr = <0>;
    qcom,poll_required = <1>;
    vlan_tag = <0 0x20>;
};

&cryptobam {
    status = "okay";
};

&wifi0 {
    status = "okay";
    nvmem-cell-names = "pre-calibration";
    nvmem-cells = <&precal_art_1000>;
    qcom,ath10k-calibration-variant = "AP-WIFI-1200";
};

&wifi1 {
    status = "okay";
    nvmem-cell-names = "pre-calibration";
    nvmem-cells = <&precal_art_5000>;
    qcom,ath10k-calibration-variant = "AP-WIFI-1200";
};
